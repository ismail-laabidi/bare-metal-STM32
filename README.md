flowchart TD
    A[Power On / Reset] --> B[Exécution du PBL]
    B --> C[Initialisation matérielle (clocks, CAN, etc.)]
    C --> D[Vérification du flag de mise à jour]
    D -- "Pas de mise à jour" --> E[Passage à l'application active]
    E --> F[Exécution normale de l'application]
    D -- "Mise à jour demandée" --> G[Lancement du Secondary Bootloader (SBL)]
    G --> H[Initialisation de l'interface CAN]
    H --> I[Réception du firmware via CAN (paquets)]
    I --> J[Assemblage des paquets dans un buffer RAM]
    J --> K[Écriture des blocs dans la banque inactive (Flash)]
    K --> L[Vérification de l'intégrité (CRC, signature)]
    L -- "Échec" --> M[Annulation de l'update et restauration du flag]
    L -- "OK" --> N[Mise à jour de la configuration de démarrage]
    N --> O[Déclenchement d'un redémarrage]
    O --> P[Au redémarrage, le PBL lit le flag mis à jour]
    P --> Q[Le PBL redirige le démarrage vers la banque mise à jour]
    Q --> R[Nouvelle application s'exécute]
